#!/usr/bin/env bash
set -eo pipefail

layersdir=$1
[ -f ./yarn.lock ] && use_yarn=true || use_yarn=false

# Download some useful tools
wget -qO /tmp/jq https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64 && chmod +x /tmp/jq
wget -qO /tmp/yj https://github.com/sclevine/yj/releases/download/v2.0/yj-linux && chmod +x /tmp/yj

echo "---> Node.js Buildpack"
node_version=10.16.0
yarn_version=1.17.3

export PATH=$layersdir/nodejs/bin:$layersdir/yarn/bin:$PATH
rm -rf node_modules

# Install node
if [[ $node_version == $([[ -f $layersdir/nodejs.toml ]] && cat $layersdir/nodejs.toml | /tmp/yj -t | /tmp/jq -r .metadata.version) ]]; then
  echo "---> Reusing Node $node_version"
else
  echo "---> Downloading and extracting Node $node_version"
  mkdir -p $layersdir/nodejs
  rm -rf $layersdir/nodejs/*

  echo "cache = true" > $layersdir/nodejs.toml
  echo "build = true" >> $layersdir/nodejs.toml
  echo "launch = true" >> $layersdir/nodejs.toml
  echo -e "[metadata]\nversion = \"$node_version\"" >> $layersdir/nodejs.toml

  nodejs_url=https://nodejs.org/dist/v10.16.0/node-v10.16.0-linux-x64.tar.xz
  wget -q -O - "$nodejs_url" | tar -xJf - -C "$layersdir/nodejs"
  mv $layersdir/nodejs/node-v10.16.0-linux-x64/* $layersdir/nodejs
  rm -r $layersdir/nodejs/node-v10.16.0-linux-x64
fi

if $use_yarn; then
  if [[ $yarn_version == $([[ -f $layersdir/yarn.toml ]] && cat $layersdir/yarn.toml | /tmp/yj -t | /tmp/jq -r .metadata.version) ]]; then
    echo "---> Reusing yarn $yarn_version"
  else
    echo "---> Installing yarn $yarn_version"
    mkdir -p $layersdir/yarn

    echo "cache = true" > $layersdir/yarn.toml
    echo "build = true" >> $layersdir/yarn.toml
    echo "launch = true" >> $layersdir/yarn.toml
    echo -e "[metadata]\nversion = \"$yarn_version\"" >> $layersdir/yarn.toml

    npm install -g yarn@$yarn_version --prefix $layersdir/yarn
  fi
fi

# Install node modules
if $use_yarn; then
  echo "---> Restoring node modules from ./yarn.lock"
  yarn install
elif [[ -f package-lock.json ]]; then
  echo "---> Restoring node modules from ./package-lock.json"
  npm install
else
  echo "---> Installing node modules"
  npm install --no-package-lock
fi

$use_yarn && start_cmd='yarn' || start_cmd='npm run'

if [[ null != $(cat package.json | /tmp/jq -r ".scripts[\"heroku-postbuild\"]") ]]; then
  echo "---> Building assets"
  $start_cmd run heroku-postbuild
elif [[ null != $(cat package.json | /tmp/jq -r .scripts.build) ]]; then
  echo "---> Building assets"
  $start_cmd build
fi

# Set default start command
echo "processes = [{ type = 'web', command = '$start_cmd start' }]" > "$layersdir/launch.toml"
